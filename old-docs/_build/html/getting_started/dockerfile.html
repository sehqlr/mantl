<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Using the Dockerfile &mdash; Mantl 1.0.3 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Mantl 1.0.3 documentation" href="../index.html" />
    <link rel="up" title="Getting Started" href="index.html" />
    <link rel="next" title="OpenStack" href="openstack.html" />
    <link rel="prev" title="Custom Playbook" href="playbook.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="openstack.html" title="OpenStack"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="playbook.html" title="Custom Playbook"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Mantl 1.0.3 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Getting Started</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="using-the-dockerfile">
<h1>Using the Dockerfile<a class="headerlink" href="#using-the-dockerfile" title="Permalink to this headline">¶</a></h1>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.3.1.</span></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Please review the <a class="reference internal" href="index.html"><em>getting started guide</em></a> for more
detailed information about setting up a cluster.</p>
</div>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Before you begin, it is recommended that you run the <a class="reference internal" href="../security/security_setup.html"><em>security-setup
script</em></a> to configure authentication and
authorization for the various components.</p>
</li>
<li><p class="first">Next, you will need to setup a Terraform template (<tt class="docutils literal"><span class="pre">*.tf</span></tt> file) in the root
directory for the cloud provider of your choices. See the following links for
more information:</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="openstack.html">OpenStack</a></li>
<li class="toctree-l1"><a class="reference internal" href="gce.html">Google Compute Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws.html">Amazon Web Services</a></li>
</ul>
</div>
</li>
<li><p class="first">Finally, you need to create a custom ansible playbook for your cluster. You
can copy <cite>sample.yml</cite> to <cite>mantl.yml</cite> in your root directory to
get started.</p>
</li>
</ol>
</div>
<div class="section" id="building-a-docker-image">
<h2>Building a Docker Image<a class="headerlink" href="#building-a-docker-image" title="Permalink to this headline">¶</a></h2>
<p>Now you&#8217;ll be able to build a docker image from the <cite>Dockerfile</cite>:</p>
<p><tt class="docutils literal"><span class="pre">docker</span> <span class="pre">build</span> <span class="pre">-t</span> <span class="pre">mi</span> <span class="pre">.</span></tt></p>
<p>In this example, we are tagging the image with the name <cite>mi</cite> which we will be
using later in this guide.</p>
</div>
<div class="section" id="running-a-container">
<h2>Running a Container<a class="headerlink" href="#running-a-container" title="Permalink to this headline">¶</a></h2>
<p>Now we can run a container from our image to provision a new cluster. Before we
do that, there are a couple of things to understand.</p>
<p>By default, our Terraform templates are configured with the assumption that you
have an SSH public key called <tt class="docutils literal"><span class="pre">id_rsa.pub</span></tt> in the <tt class="docutils literal"><span class="pre">.ssh</span></tt> folder of your home
directory (along with a corresponding private key). Terraform uses this to
authorize your key on the cluster nodes that it creates. This provides you with
SSH access to the nodes which is required for the subsequent Ansible
provisioning. The simplest way to handle this when running from a Docker
container is to mount your <tt class="docutils literal"><span class="pre">~/.ssh</span></tt> folder in the container. You will see an
example of this later in the document.</p>
<p>Another important thing to understand is how Terraform manages <a class="reference external" href="https://www.terraform.io/docs/state/index.html">state</a>. Terraform uses a <cite>JSON</cite>
formatted file to store the state of your managed infrastructure. This state
file is important as it will allow you to use Terraform to plan, inspect, modify
and destroy resources in your infrastructure. By default, Terraform writes state
to a file called <tt class="docutils literal"><span class="pre">terraform.tfstate</span></tt> in the same directory where you launched
Terraform. Our <tt class="docutils literal"><span class="pre">Dockerfile</span></tt> is configured to store the state in a Docker
volume called <tt class="docutils literal"><span class="pre">/state</span></tt>. This will allow you to mount that volume so that you
can easily access the <tt class="docutils literal"><span class="pre">terraform.tfstate</span></tt> file to use for future Terraform
runs.</p>
<p>Now we can use this information to run our container:</p>
<p><tt class="docutils literal"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-it</span> <span class="pre">-v</span> <span class="pre">~/.ssh/:/ssh/</span> <span class="pre">-v</span> <span class="pre">$PWD:/state</span> <span class="pre">mi</span></tt></p>
<p>As discussed above we are launching a container from the <tt class="docutils literal"><span class="pre">mi</span></tt> image we created
earlier, while mounting our local <tt class="docutils literal"><span class="pre">~/.ssh/</span></tt> to <tt class="docutils literal"><span class="pre">/ssh</span></tt> in the container, and
our current directory to the container&#8217;s <tt class="docutils literal"><span class="pre">/state</span></tt>. Therefore, the
<tt class="docutils literal"><span class="pre">terraform.tfstate</span></tt> files will be accessible from our local host directory
after the run. Note that we are also allocating a TTY for the container process
(using <tt class="docutils literal"><span class="pre">-it</span></tt>) so that we can enter our SSH key passphrase if necessary.</p>
<p>The container should launch and provision the cluster using the <tt class="docutils literal"><span class="pre">security.yml</span></tt>,
Terraform template, and custom playbook that you configured in the Setup above.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If you have customized your Terraform template to use a different SSH
public key than the default <tt class="docutils literal"><span class="pre">~/.ssh/id_rsa.pub</span></tt>, you can specify the
corresponding private key as an environment variable (<tt class="docutils literal"><span class="pre">SSH_KEY</span></tt>)
when running the container. For example:</p>
<p class="last"><tt class="docutils literal"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-it</span> <span class="pre">-e</span> <span class="pre">SSH_KEY=/root/.ssh/otherpvtkey</span> <span class="pre">-v</span> <span class="pre">~/.ssh/:/ssh/</span> <span class="pre">-v</span> <span class="pre">$PWD:/state</span> <span class="pre">mi</span></tt></p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/cisco.png" alt="Logo"/>
    
    <h1 class="logo logo-name">Mantl</h2>
    
  </a>
</p>





<p>
<iframe src="http://ghbtns.com/github-btn.html?user=ciscocloud&repo=mantl&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>


<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html#general-information-about-mantl-with-ansible">General Information about Mantl with Ansible</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#preparing-to-provision-cloud-hosts">Preparing to provision Cloud Hosts</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#deploying-software-via-ansible">Deploying software via Ansible</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#checking-your-deployment">Checking your deployment</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../components/index.html">Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../addons.html">Addons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../packer.html">Packer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">Licenses</a></li>
</ul>


<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Cisco Systems, Incorporated.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.2.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.6.3</a>
      
      |
      <a href="../_sources/getting_started/dockerfile.txt"
          rel="nofollow">Page source</a></li>
    </div>

    

    
  </body>
</html>