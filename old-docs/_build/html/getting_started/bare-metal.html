<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Bare-Metal &mdash; Mantl 1.0.3 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Mantl 1.0.3 documentation" href="../index.html" />
    <link rel="up" title="Getting Started" href="index.html" />
    <link rel="next" title="Vagrant" href="vagrant.html" />
    <link rel="prev" title="CenturyLinkCloud" href="clc.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="vagrant.html" title="Vagrant"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="clc.html" title="CenturyLinkCloud"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Mantl 1.0.3 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Getting Started</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="bare-metal">
<h1>Bare-Metal<a class="headerlink" href="#bare-metal" title="Permalink to this headline">¶</a></h1>
<p>By bare-metal we mean a set of physical computers that have Centos 7
installed on them.</p>
<p>If you are using Openstack, VMware, or some other cloud provider,
Mantl.io has terraform scripts for you. From a Mantl.io perspective,
this doc is about setting up the inventory file by hand and preparing
the machines to a state similar to what terraform would have done.</p>
<p>The minimum requirements for installing Mantl (based on the AWS sample) are
edge, control and worker nodes with 1 core and about 4 GB of RAM.  This
documentation is really a description of how to set up a static inventory file
when you don&#8217;t create your inventory with <tt class="docutils literal"><span class="pre">terraform.py</span></tt>.  There is nothing
about this document that requires that they be physical systems.</p>
<dl class="docutils">
<dt>This document explains:</dt>
<dd><ul class="first last simple">
<li>Preparing your machines with Centos</li>
<li>Network and storage concerns</li>
<li>Creating your inventory</li>
<li>Setting up Ansible</li>
</ul>
</dd>
</dl>
<div class="section" id="setting-up-centos-7">
<h2>Setting Up Centos 7<a class="headerlink" href="#setting-up-centos-7" title="Permalink to this headline">¶</a></h2>
<div class="section" id="thumb-drive-install">
<h3>Thumb Drive Install<a class="headerlink" href="#thumb-drive-install" title="Permalink to this headline">¶</a></h3>
<p>There are much more professional ways of creating your instances, but if
you are looking for a solution for a couple machines at home, perhaps
you actually need some tips on how to do it. The least technical way to
do this is with a thumb drive.</p>
<p>Create a bootable USB drive with Centos 7. This can be a bit confusing, we
recommend the following two tutorials for OSX:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://www.myiphoneadventure.com/os-x/create-a-bootable-centos-usb-drive-with-a-mac-os-x">http://www.myiphoneadventure.com/os-x/create-a-bootable-centos-usb-drive-with-a-mac-os-x</a></li>
<li><a class="reference external" href="http://www.ubuntu.com/download/desktop/create-a-usb-stick-on-mac-osx">http://www.ubuntu.com/download/desktop/create-a-usb-stick-on-mac-osx</a></li>
</ul>
</div></blockquote>
<p>Mantl.io requires the latest build of Centos 7.</p>
<p>During installation you will use the defaults except:</p>
<ul class="simple">
<li>Manually configure your partitions. On the Manual partioning page:</li>
<li>Remove existing partitions</li>
<li>Press the button to automatically partition. This will give you a
default set to start with.</li>
<li>The automatic partioning will put 50 toward root and the rest in
home, change this:<ul>
<li>These are services machines and won&#8217;t store many files in home,
Home should be set to a small partion size leaving you with some
unpartioned space.</li>
<li>You will need to leave unformatted space on the drive for docker.
Try to leave at least 50 unformated for the docker LVM partion
that is described in the &#8220;Create Partion for Docker LVM&#8221; section
below.</li>
</ul>
</li>
<li>Turn on your wired internet connection. It should just be a toggle
switch for your device.</li>
<li>Once the install starts it asks for a root password and a first user.</li>
<li>Having a <tt class="docutils literal"><span class="pre">centos</span></tt> admin user will match what happens in cloud
environments.</li>
</ul>
<p>Once rebooted, if you forgot to turn on your internet in the install,
you can set it up using the following tutorial:
<a class="reference external" href="http://www.krizna.com/centos/setup-network-centos-7/">http://www.krizna.com/centos/setup-network-centos-7/</a> . It might be
easier and more automated (therefore less error prone) to just reinstall
and remember to turn on your internet during the install.</p>
</div>
<div class="section" id="set-up-base-network">
<h3>Set up Base Network<a class="headerlink" href="#set-up-base-network" title="Permalink to this headline">¶</a></h3>
<div class="section" id="chosing-a-static-ip-range">
<h4>Chosing a static IP range<a class="headerlink" href="#chosing-a-static-ip-range" title="Permalink to this headline">¶</a></h4>
<p>I chose 172.16.222.x because its unlikely to overlap with any network I
might move this cluster too.</p>
</div>
<div class="section" id="give-it-a-static-ip-and-set-dns-and-gateway">
<h4>Give it a static IP and set DNS and Gateway<a class="headerlink" href="#give-it-a-static-ip-and-set-dns-and-gateway" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://ask.xmodulo.com/configure-static-ip-address-centos7.html">http://ask.xmodulo.com/configure-static-ip-address-centos7.html</a></p>
<p>At the command line enter:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>ip addr
</pre></div>
</div>
<p>You should see somethng like:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eno1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether b8:ae:ed:71:6c:06 brd ff:ff:ff:ff:ff:ff
    inet 172.16.222.22/24 brd 172.16.222.255 scope global eno1
       valid_lft forever preferred_lft forever
    inet6 fe80::baae:edff:fe71:6c06/64 scope link
       valid_lft forever preferred_lft forever
</pre></div>
</div>
<p>from this you can see that eno1 is the ethernet device.</p>
<p>Edit <tt class="docutils literal"><span class="pre">/etc/sysconfig/network-scripts/ifcfg-eno1</span></tt></p>
<p>You can leave everything that is in there but you need to to change or
add the following. BOOTPROTO and ONBOOT are probably already there.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">BOOTPROTO</span><span class="o">=</span><span class="s2">&quot;static&quot;</span>
<span class="n">IPADDR</span><span class="o">=</span><span class="s2">&quot;172.16.222.6&quot;</span>
<span class="n">GATEWAY</span><span class="o">=</span><span class="s2">&quot;172.16.222.1&quot;</span>
<span class="n">NETMASK</span><span class="o">=</span><span class="s2">&quot;255.255.255.0&quot;</span>
<span class="n">DNS1</span><span class="o">=</span><span class="s2">&quot;8.8.8.8&quot;</span>
<span class="n">DNS2</span><span class="o">=</span><span class="s2">&quot;208.67.222.222&quot;</span>
<span class="n">NM_CONTROLLED</span><span class="o">=</span><span class="n">no</span>
<span class="n">ONBOOT</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
</pre></div>
</div>
<p>The DNS lines are going to have to change once consul is up.</p>
<p>NOTE: in Centos 7 /etc/resolv.conf is a generated file.</p>
<p>You could also put the dns lines in /etc/sysconfig/network.</p>
<p>Permanently change your hostname with:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>hostnamectl set-hostname edge22
</pre></div>
</div>
<p>After saving then finally:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>systemctl restart network
</pre></div>
</div>
</div>
</div>
<div class="section" id="create-partion-for-docker-lvm">
<h3>Create Partion For Docker LVM<a class="headerlink" href="#create-partion-for-docker-lvm" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>su</li>
<li>parted /dev/sda print</li>
<li>fdisk /dev/sda</li>
<li>Command: n</li>
<li>partion : default</li>
<li>please note which partition it is in. So if its partition 5,
eventually you will need to tell mantl /dev/sda5 for the LVM</li>
<li>you kinda want all your machines to use the same partition because
this partition is entered as a system wide variable.</li>
<li>first sector: default</li>
<li>last sector: +50G</li>
<li>Command: w</li>
<li>reboot</li>
</ul>
<p>Don&#8217;t put a file system on the partion.</p>
<p>Note that I am creating a partion size 50 Gigs, this is for docker. Just
make it consistent across your cluster.</p>
<p>There are two main types of drives on the market today. The older type
of drive is said to have MS-DOS partions. When partioning these types of
drives you will be asked if you want to create a <tt class="docutils literal"><span class="pre">primary</span></tt> partion or
a <tt class="docutils literal"><span class="pre">extended</span></tt> partition. You will need to make it a <tt class="docutils literal"><span class="pre">primary</span></tt>
partition.</p>
<p>Additionally, if you have a MS-DOS partioned drive you may have to run
the following patch:
<a class="reference external" href="https://github.com/ansible/ansible-modules-extras/issues/1504">https://github.com/ansible/ansible-modules-extras/issues/1504</a> against
the file /Library/lvg.py. If during the ansible run (as described in the
section &#8220;Run It!&#8221; below) the run hangs on task <tt class="docutils literal"><span class="pre">lvm</span> <span class="pre">|</span> <span class="pre">create</span> <span class="pre">volume</span>
<span class="pre">group</span></tt> then you will need to follow the instructions in issue 1504.</p>
</div>
</div>
<div class="section" id="creating-your-inventory">
<h2>Creating Your Inventory<a class="headerlink" href="#creating-your-inventory" title="Permalink to this headline">¶</a></h2>
<p>Here is an example inventory file. It should be placed in the root of
the mantl directory.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[role=control]
control-01 private_ipv4=172.16.222.6 ansible_ssh_host=172.16.222.6
control-02 private_ipv4=172.16.222.7 ansible_ssh_host=172.16.222.7
control-03 private_ipv4=172.16.222.8 ansible_ssh_host=172.16.222.8

[role=control:vars]
consul_is_server=true
lvm_physical_device=/dev/sda3

[role=worker]
worker-001 private_ipv4=172.16.222.11 ansible_ssh_host=172.16.222.11
worker-002 private_ipv4=172.16.222.12 ansible_ssh_host=172.16.222.12
worker-003 private_ipv4=172.16.222.13 ansible_ssh_host=172.16.222.13

[role=worker:vars]
consul_is_server=false
lvm_physical_device=/dev/sda3

[role=edge]
edge-01 private_ipv4=172.16.222.16 ansible_ssh_host=172.16.222.16
edge-02 private_ipv4=172.16.222.17 ansible_ssh_host=172.16.222.17

[role=edge:vars]
consul_is_server=false
lvm_physical_device=/dev/sda3

[dc=dc1]
control-01
control-02
control-03
worker-001
worker-002
worker-003
edge-01
edge-02
</pre></div>
</div>
<p>I had to add the <tt class="docutils literal"><span class="pre">ansible_ssh_host</span></tt> line to run
<tt class="docutils literal"><span class="pre">playbooks/reboot-hosts.yml</span></tt> and the <tt class="docutils literal"><span class="pre">private_ipv4</span></tt> is needed by several
roles.</p>
<p>The <tt class="docutils literal"><span class="pre">dc=dc1</span></tt> group is needed to set <tt class="docutils literal"><span class="pre">consul_dc_group</span></tt> in the consul role.
It is used in the dnsmasq role.  <tt class="docutils literal"><span class="pre">dc1</span></tt> is the default. If you change the name
of the data center in your inventory file you will need to set the <tt class="docutils literal"><span class="pre">consul_dc</span></tt>
variable. For example, if you called your dc &#8216;mydc&#8217; then you would need to
enter:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>ansible-playbook -u centos -i inventory -e consul_dc=mydc \
        -e provider=bare-metal  -e @security.yml  sample.yml &gt;&amp; bare-metal.log
</pre></div>
</div>
<p>The rest of the options will be discussed below.</p>
</div>
<div class="section" id="getting-started-with-ansible">
<h2>Getting Started with Ansible<a class="headerlink" href="#getting-started-with-ansible" title="Permalink to this headline">¶</a></h2>
<p>Add your key to all the machines in your inventory</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>ansible all -i inventory  -u centos -k -m authorized_key -a &quot;user=centos key=https://github.com/youraccount.keys&quot;
</pre></div>
</div>
<p>Note this makes use of your public key on Github. If you don&#8217;t have a
Github account or a key pair on your Github account, please look at the
documentation for Ansible <tt class="docutils literal"><span class="pre">authorized_key</span></tt> module for other options.</p>
<p>The <tt class="docutils literal"><span class="pre">-k</span></tt> is needed because the ssh connection is still uses password based
authentication.</p>
<p>After this authorization step has been completed, all commands can
happen without the password and <tt class="docutils literal"><span class="pre">-k</span></tt> option. Test with:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>ansible all -i inventory -u centos -m ping
</pre></div>
</div>
<p>You should get back a pong from each machine in your inventory.</p>
<div class="section" id="copy-the-etc-host-file-over">
<h3>Copy the /etc/host file over<a class="headerlink" href="#copy-the-etc-host-file-over" title="Permalink to this headline">¶</a></h3>
<p>Add your nodes to /etc/hosts:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
172.16.222.5 MyMac
172.16.222.6 control-01
172.16.222.7 control-02
172.16.222.8 control-03
172.16.222.11 worker-01
172.16.222.12 worker-02
172.16.222.13 worker-03
172.16.222.16 edge-01
172.16.222.17 edge-02
</pre></div>
</div>
<p>Copy the /etc/hosts file over to all your nodes:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>ansible all -i inventory -u centos --sudo --ask-sudo-pass -m copy -a &quot;src=hosts dest=/etc/hosts&quot;
</pre></div>
</div>
</div>
</div>
<div class="section" id="run-it">
<h2>Run It!<a class="headerlink" href="#run-it" title="Permalink to this headline">¶</a></h2>
<p>You now are ready to run the playbook. Change directory to the project root.
Your inventory should be there.</p>
<p>Run the security-setup script:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>./security-setup
</pre></div>
</div>
<p>It asks for one admin password. At the end of that run there will be a
<tt class="docutils literal"><span class="pre">security.yml</span></tt> file. It will have the password you entered and a lot
of keys needed for installation.</p>
<p>The playbook you will be running is <tt class="docutils literal"><span class="pre">sample.yml</span></tt>. Since you created
your own inventory and didn&#8217;t use terraform, there are a few variables
you need to set for your run.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>ansible-playbook -u centos -i inventory \
        -e provider=bare-metal \
        -e consul_dc=dc1 \
        -e docker_lvm_backed=true \
        -e docker_lvm_data_volume_size=&quot;80%FREE&quot; \
        -e @security.yml  sample.yml &gt;&amp; bare-metal.log
</pre></div>
</div>
<p>In another window tail -f that log file to follow whats going on.</p>
<p>The meaning of the parts of this command are as follows:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">ansible-playbook</span> <span class="pre">-u</span> <span class="pre">centos</span> <span class="pre">-i</span> <span class="pre">inventory</span></tt></dt>
<dd>run the ansible play book as centos user against the inventory found in the
./inventory file.</dd>
<dt><tt class="docutils literal"><span class="pre">-e</span> <span class="pre">provider=bare-metal</span></tt></dt>
<dd>The &#8220;provider&#8221; is bare-metal where a user sets up the infrastructure and
then creates an inventory file as described above.  If the inventory had
been generated by terraform.py against a terraform state file for
infrastructure built on Google Cloud, this value would have been set
automatically to &#8216;gcs&#8217;</dd>
<dt><tt class="docutils literal"><span class="pre">-e</span> <span class="pre">consul_dc=dc1</span></tt></dt>
<dd>This is the name found in your ./inventory file for your datacenter.</dd>
<dt><tt class="docutils literal"><span class="pre">-e</span> <span class="pre">docker_lvm_backed=true</span></tt></dt>
<dd>LVM-backed docker is a really good idea in centos. This is why you craeted
the extra partion during installation.</dd>
<dt><tt class="docutils literal"><span class="pre">-e</span> <span class="pre">docker_lvm_data_volume_size=&quot;80%FREE&quot;</span></tt></dt>
<dd>This defaults to &#8220;40%FREE&#8221; in the docker role because the default LVM
partition is shared with other things. You could leave this off, but its
likely with your own hardware you will have different constraints and its a
good variable to know.</dd>
<dt><tt class="docutils literal"><span class="pre">-e</span> <span class="pre">&#64;security.yml</span></tt></dt>
<dd>This a series of variables that have all the security settings of the
various parts of Mantl. The &#64; causes Ansible to evaluate the file.</dd>
<dt><tt class="docutils literal"><span class="pre">sample.yml</span></tt></dt>
<dd>This is the ansible file that is being run.</dd>
<dt><tt class="docutils literal"><span class="pre">&gt;&amp;</span> <span class="pre">bare-metal.log</span></tt></dt>
<dd>This redirects the output to a file so that you can review it later.
Tailing with a -f flag lets you watch the progress as ansible works through
the rolls accross your inventory.</dd>
</dl>
<p>Once you are done go to the browser and go to the IP address of any
control node and you should see the Mantl UI. For the inventory shown
above, you could go to <tt class="docutils literal"><span class="pre">172.16.222.6/ui</span></tt>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/cisco.png" alt="Logo"/>
    
    <h1 class="logo logo-name">Mantl</h2>
    
  </a>
</p>





<p>
<iframe src="http://ghbtns.com/github-btn.html?user=ciscocloud&repo=mantl&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>


<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html#general-information-about-mantl-with-ansible">General Information about Mantl with Ansible</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html#preparing-to-provision-cloud-hosts">Preparing to provision Cloud Hosts</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#deploying-software-via-ansible">Deploying software via Ansible</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#checking-your-deployment">Checking your deployment</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../components/index.html">Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../addons.html">Addons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../packer.html">Packer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">Licenses</a></li>
</ul>


<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Cisco Systems, Incorporated.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.2.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.6.3</a>
      
      |
      <a href="../_sources/getting_started/bare-metal.txt"
          rel="nofollow">Page source</a></li>
    </div>

    

    
  </body>
</html>